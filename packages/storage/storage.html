<!DOCTYPE html>
<!--
 Copyright 2021 Red Hat, Inc

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<html>
<head>
<title>storage.go</title>
<meta charset="utf-8"/>
<style type="text/css">body {
    background: rgb(225, 225, 225);
    margin: 0px;
    padding: 0px;
}

#docgo p {
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo div {
    display: inline;
}

#docgo #background {
    position: fixed;
    top: 0; left: 525px; right: 0; bottom: 0;
    background: rgb(47, 47, 47);
    border-left: 1px solid #e5e5ee;
    z-index: -1;
}

#docgo .keyword {
    color: rgb(250, 200, 100);
}

#docgo .literal {
    color: rgb(140, 190, 100);
}

#docgo .ident {
    color: white;
}

#docgo .operator {
    color: white;
}

#docgo .comment {
}

#docgo h1, h2, h3, h4, h5 {
    text-align: left;
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo h1 {
    margin-top: 40px;
}

#docgo .doc {
    vertical-align: top;
    font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
    font-size: 15px;
    line-height: 22px;
    color: black;
    min-width: 450px;
    max-width: 450px;
    padding-top: 10px;
    padding-right: 25px;
    padding-bottom: 1px;
    padding-left: 50px;
    overflow-x: hidden;
}

#docgo .code {
    min-width: 650px;
    max-width: 650px;
    padding-left: 25px;
    padding-right: 15px;
    border-left: 1px;
    overflow-x: hidden;
    vertical-align: top;
}

#docgo .code pre code  {
    font-size: 12px;
    line-height: 18px;
    font-family: Menlo, Monaco, Consolas, "Lucida Console", monospace;
    color: rgb(120, 120, 120);
}
</style>
</head>
<body>
<div id="docgo">
  <div id="background"></div>
  <table>
    <thead><tr><th class="doc"><h1>storage.go</h1></th><th class="code"></th></tr></thead>
    <tbody>
      
      <tr class="section">
	<td class="doc"></td>
	<td class="code"><pre><code><div class="comment">/*
Copyright Â© 2020 Red Hat, Inc.

Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
*/</div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Package storage contains an implementation of interface between Go code and
(almost any) SQL database like PostgreSQL, SQLite, or MariaDB. An implementation
named DBStorage is constructed via New function and it is mandatory to call Close
for any opened connection to database. The storage might be initialized by Init
method if database schema is empty.</p>

<p>It is possible to configure connection to selected database by using Configuration
structure. Currently that structure contains two configurable parameter:</p>

<p>Driver - a SQL driver, like &quot;sqlite3&quot;, &quot;pq&quot; etc.
DataSource - specification of data source. The content of this parameter depends on the database used.</p>
</td>
	<td class="code"><pre><code><div class="keyword">package</div> <div class="ident">storage</div><div class="operator"></div>

<div class="keyword">import</div> <div class="operator">(</div>
	<div class="literal">&#34;database/sql&#34;</div><div class="operator"></div>
	<div class="ident">sql_driver</div> <div class="literal">&#34;database/sql/driver&#34;</div><div class="operator"></div>
	<div class="literal">&#34;encoding/json&#34;</div><div class="operator"></div>
	<div class="literal">&#34;fmt&#34;</div><div class="operator"></div>
	<div class="literal">&#34;strings&#34;</div><div class="operator"></div>
	<div class="literal">&#34;time&#34;</div><div class="operator"></div>

	<div class="literal">&#34;github.com/Shopify/sarama&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/lib/pq&#34;</div><div class="operator"></div>
	<div class="ident">_</div> <div class="literal">&#34;github.com/lib/pq&#34;</div> <div class="operator"></div><div class="comment">// PostgreSQL database driver</div>
	<div class="literal">&#34;github.com/mattn/go-sqlite3&#34;</div><div class="operator"></div>
	<div class="ident">_</div> <div class="literal">&#34;github.com/mattn/go-sqlite3&#34;</div> <div class="operator"></div><div class="comment">// SQLite database driver</div>
	<div class="literal">&#34;github.com/rs/zerolog/log&#34;</div><div class="operator"></div>

	<div class="ident">utypes</div> <div class="literal">&#34;github.com/RedHatInsights/insights-operator-utils/types&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/RedHatInsights/insights-results-aggregator/metrics&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/RedHatInsights/insights-results-aggregator/migration&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/RedHatInsights/insights-results-aggregator/types&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Storage represents an interface to almost any database or storage system</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">Storage</div> <div class="keyword">interface</div> <div class="operator">{</div>
	<div class="ident">Init</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
	<div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
	<div class="ident">ListOfOrgs</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">ListOfClustersForOrg</div><div class="operator">(</div>
		<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">timeLimit</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Time</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">ListOfClustersForOrgSpecificRule</div><div class="operator">(</div>
		<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">ruleID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">RuleSelector</div><div class="operator">,</div> <div class="ident">activeClusters</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">,</div>
	<div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">utypes</div><div class="operator">.</div><div class="ident">HittingClustersData</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">ReadReportForCluster</div><div class="operator">(</div>
		<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RuleOnReport</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">ReadReportsForClusters</div><div class="operator">(</div>
		<div class="ident">clusterNames</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div> <div class="operator">(</div><div class="keyword">map</div><div class="operator">[</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReport</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">ReadOrgIDsForClusters</div><div class="operator">(</div>
		<div class="ident">clusterNames</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">ReadSingleRuleTemplateData</div><div class="operator">(</div>
		<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div> <div class="ident">ruleID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">,</div> <div class="ident">errorKey</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ErrorKey</div><div class="operator">,</div>
	<div class="operator">)</div> <div class="operator">(</div><div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">ReadReportForClusterByClusterName</div><div class="operator">(</div><div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RuleOnReport</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">GetLatestKafkaOffset</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">types</div><div class="operator">.</div><div class="ident">KafkaOffset</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">WriteReportForCluster</div><div class="operator">(</div>
		<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">report</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReport</div><div class="operator">,</div>
		<div class="ident">rules</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ReportItem</div><div class="operator">,</div>
		<div class="ident">collectedAtTime</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Time</div><div class="operator">,</div>
		<div class="ident">kafkaOffset</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">KafkaOffset</div><div class="operator">,</div>
	<div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
	<div class="ident">WriteRecommendationsForCluster</div><div class="operator">(</div>
		<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">report</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReport</div><div class="operator">,</div>
	<div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
	<div class="ident">ReportsCount</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">int</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">VoteOnRule</div><div class="operator">(</div>
		<div class="ident">clusterID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">ruleID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">,</div>
		<div class="ident">errorKey</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ErrorKey</div><div class="operator">,</div>
		<div class="ident">userID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
		<div class="ident">userVote</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserVote</div><div class="operator">,</div>
		<div class="ident">voteMessage</div> <div class="ident">string</div><div class="operator">,</div>
	<div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
	<div class="ident">AddOrUpdateFeedbackOnRule</div><div class="operator">(</div>
		<div class="ident">clusterID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">ruleID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">,</div>
		<div class="ident">errorKey</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ErrorKey</div><div class="operator">,</div>
		<div class="ident">userID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
		<div class="ident">message</div> <div class="ident">string</div><div class="operator">,</div>
	<div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
	<div class="ident">AddFeedbackOnRuleDisable</div><div class="operator">(</div>
		<div class="ident">clusterID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">ruleID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">,</div>
		<div class="ident">errorKey</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ErrorKey</div><div class="operator">,</div>
		<div class="ident">userID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
		<div class="ident">message</div> <div class="ident">string</div><div class="operator">,</div>
	<div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
	<div class="ident">GetUserFeedbackOnRule</div><div class="operator">(</div>
		<div class="ident">clusterID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">ruleID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">,</div>
		<div class="ident">errorKey</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ErrorKey</div><div class="operator">,</div>
		<div class="ident">userID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
	<div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">UserFeedbackOnRule</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">GetUserFeedbackOnRuleDisable</div><div class="operator">(</div>
		<div class="ident">clusterID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">ruleID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">,</div>
		<div class="ident">errorKey</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ErrorKey</div><div class="operator">,</div>
		<div class="ident">userID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
	<div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">UserFeedbackOnRule</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">DeleteReportsForOrg</div><div class="operator">(</div><div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
	<div class="ident">DeleteReportsForCluster</div><div class="operator">(</div><div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
	<div class="ident">ToggleRuleForCluster</div><div class="operator">(</div>
		<div class="ident">clusterID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">ruleID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">,</div>
		<div class="ident">errorKey</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ErrorKey</div><div class="operator">,</div>
		<div class="ident">userID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
		<div class="ident">ruleToggle</div> <div class="ident">RuleToggle</div><div class="operator">,</div>
	<div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
	<div class="ident">GetFromClusterRuleToggle</div><div class="operator">(</div>
		<div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">,</div>
	<div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">ClusterRuleToggle</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">GetTogglesForRules</div><div class="operator">(</div>
		<div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RuleOnReport</div><div class="operator">,</div>
	<div class="operator">)</div> <div class="operator">(</div><div class="keyword">map</div><div class="operator">[</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">]</div><div class="ident">bool</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">DeleteFromRuleClusterToggle</div><div class="operator">(</div>
		<div class="ident">clusterID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">ruleID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">,</div>
	<div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
	<div class="ident">GetOrgIDByClusterID</div><div class="operator">(</div><div class="ident">cluster</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">WriteConsumerError</div><div class="operator">(</div><div class="ident">msg</div> <div class="operator">*</div><div class="ident">sarama</div><div class="operator">.</div><div class="ident">ConsumerMessage</div><div class="operator">,</div> <div class="ident">consumerErr</div> <div class="ident">error</div><div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
	<div class="ident">GetUserFeedbackOnRules</div><div class="operator">(</div>
		<div class="ident">clusterID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">rulesReport</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RuleOnReport</div><div class="operator">,</div>
		<div class="ident">userID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
	<div class="operator">)</div> <div class="operator">(</div><div class="keyword">map</div><div class="operator">[</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">UserVote</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">GetUserDisableFeedbackOnRules</div><div class="operator">(</div>
		<div class="ident">clusterID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">rulesReport</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RuleOnReport</div><div class="operator">,</div>
		<div class="ident">userID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
	<div class="operator">)</div> <div class="operator">(</div><div class="keyword">map</div><div class="operator">[</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">]</div><div class="ident">UserFeedbackOnRule</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">DoesClusterExist</div><div class="operator">(</div><div class="ident">clusterID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">bool</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">ListOfDisabledRules</div><div class="operator">(</div><div class="ident">userID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">utypes</div><div class="operator">.</div><div class="ident">DisabledRule</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">ListOfReasons</div><div class="operator">(</div><div class="ident">userID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">DisabledRuleReason</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">RateOnRule</div><div class="operator">(</div>
		<div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
		<div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">,</div>
		<div class="ident">types</div><div class="operator">.</div><div class="ident">ErrorKey</div><div class="operator">,</div>
		<div class="ident">types</div><div class="operator">.</div><div class="ident">UserVote</div><div class="operator">,</div>
	<div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
	<div class="ident">GetRuleRating</div><div class="operator">(</div>
		<div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
		<div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">types</div><div class="operator">.</div><div class="ident">RuleSelector</div><div class="operator">,</div>
	<div class="operator">)</div> <div class="operator">(</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RuleRating</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">DisableRuleSystemWide</div><div class="operator">(</div>
		<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">userID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
		<div class="ident">ruleID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">,</div> <div class="ident">errorKey</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ErrorKey</div><div class="operator">,</div>
		<div class="ident">justification</div> <div class="ident">string</div><div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
	<div class="ident">EnableRuleSystemWide</div><div class="operator">(</div>
		<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">userID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
		<div class="ident">ruleID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">,</div> <div class="ident">errorKey</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ErrorKey</div><div class="operator">,</div>
	<div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
	<div class="ident">UpdateDisabledRuleJustification</div><div class="operator">(</div>
		<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">userID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
		<div class="ident">ruleID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">,</div> <div class="ident">errorKey</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ErrorKey</div><div class="operator">,</div>
		<div class="ident">justification</div> <div class="ident">string</div><div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
	<div class="ident">ReadDisabledRule</div><div class="operator">(</div>
		<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">userID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
		<div class="ident">ruleID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">,</div> <div class="ident">errorKey</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ErrorKey</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">utypes</div><div class="operator">.</div><div class="ident">SystemWideRuleDisable</div><div class="operator">,</div> <div class="ident">bool</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">ListOfSystemWideDisabledRules</div><div class="operator">(</div>
		<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">userID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">utypes</div><div class="operator">.</div><div class="ident">SystemWideRuleDisable</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">ReadRecommendationsForClusters</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">utypes</div><div class="operator">.</div><div class="ident">RecommendationImpactedClusters</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>DBStorage is an implementation of Storage interface that use selected SQL like database
like SQLite, PostgreSQL, MariaDB, RDS etc. That implementation is based on the standard
sql package. It is possible to configure connection via Configuration structure.
SQLQueriesLog is log for sql queries, default is nil which means nothing is logged</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">DBStorage</div> <div class="keyword">struct</div> <div class="operator">{</div>
	<div class="ident">connection</div>   <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator"></div>
	<div class="ident">dbDriverType</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriver</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>clusterLastCheckedDict is a dictionary of timestamps when the clusters were last checked.</p>
</td>
	<td class="code"><pre><code>	<div class="ident">clustersLastChecked</div> <div class="keyword">map</div><div class="operator">[</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">]</div><div class="ident">time</div><div class="operator">.</div><div class="ident">Time</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>New function creates and initializes a new instance of Storage interface</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">New</div><div class="operator">(</div><div class="ident">configuration</div> <div class="ident">Configuration</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">DBStorage</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">driverType</div><div class="operator">,</div> <div class="ident">driverName</div><div class="operator">,</div> <div class="ident">dataSource</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">initAndGetDriver</div><div class="operator">(</div><div class="ident">configuration</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div>
		<div class="literal">&#34;Making connection to data storage, driver=%s datasource=%s&#34;</div><div class="operator">,</div>
		<div class="ident">driverName</div><div class="operator">,</div> <div class="ident">dataSource</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>

	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sql</div><div class="operator">.</div><div class="ident">Open</div><div class="operator">(</div><div class="ident">driverName</div><div class="operator">,</div> <div class="ident">dataSource</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Can not connect to data storage&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">NewFromConnection</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="ident">driverType</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>NewFromConnection function creates and initializes a new instance of Storage interface from prepared connection</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">NewFromConnection</div><div class="operator">(</div><div class="ident">connection</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">,</div> <div class="ident">dbDriverType</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriver</div><div class="operator">)</div> <div class="operator">*</div><div class="ident">DBStorage</div> <div class="operator">{</div>
	<div class="keyword">return</div> <div class="operator">&amp;</div><div class="ident">DBStorage</div><div class="operator">{</div>
		<div class="ident">connection</div><div class="operator">:</div>          <div class="ident">connection</div><div class="operator">,</div>
		<div class="ident">dbDriverType</div><div class="operator">:</div>        <div class="ident">dbDriverType</div><div class="operator">,</div>
		<div class="ident">clustersLastChecked</div><div class="operator">:</div> <div class="keyword">map</div><div class="operator">[</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">]</div><div class="ident">time</div><div class="operator">.</div><div class="ident">Time</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>initAndGetDriver initializes driver(with logs if logSQLQueries is true),
checks if it's supported and returns driver type, driver name, dataSource and error</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">initAndGetDriver</div><div class="operator">(</div><div class="ident">configuration</div> <div class="ident">Configuration</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">driverType</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriver</div><div class="operator">,</div> <div class="ident">driverName</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">dataSource</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">err</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">driver</div> <div class="ident">sql_driver</div><div class="operator">.</div><div class="ident">Driver</div><div class="operator"></div>
	<div class="ident">driverName</div> <div class="operator">=</div> <div class="ident">configuration</div><div class="operator">.</div><div class="ident">Driver</div><div class="operator"></div>

	<div class="keyword">switch</div> <div class="ident">driverName</div> <div class="operator">{</div>
	<div class="keyword">case</div> <div class="literal">&#34;sqlite3&#34;</div><div class="operator">:</div>
		<div class="ident">driverType</div> <div class="operator">=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverSQLite3</div><div class="operator"></div>
		<div class="ident">driver</div> <div class="operator">=</div> <div class="operator">&amp;</div><div class="ident">sqlite3</div><div class="operator">.</div><div class="ident">SQLiteDriver</div><div class="operator">{</div><div class="operator">}</div><div class="operator"></div>
		<div class="ident">dataSource</div> <div class="operator">=</div> <div class="ident">configuration</div><div class="operator">.</div><div class="ident">SQLiteDataSource</div><div class="operator"></div>
	<div class="keyword">case</div> <div class="literal">&#34;postgres&#34;</div><div class="operator">:</div>
		<div class="ident">driverType</div> <div class="operator">=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverPostgres</div><div class="operator"></div>
		<div class="ident">driver</div> <div class="operator">=</div> <div class="operator">&amp;</div><div class="ident">pq</div><div class="operator">.</div><div class="ident">Driver</div><div class="operator">{</div><div class="operator">}</div><div class="operator"></div>
		<div class="ident">dataSource</div> <div class="operator">=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprintf</div><div class="operator">(</div>
			<div class="literal">&#34;postgresql://%v:%v@%v:%v/%v?%v&#34;</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGUsername</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGPassword</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGHost</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGPort</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGDBName</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGParams</div><div class="operator">,</div>
		<div class="operator">)</div><div class="operator"></div>
	<div class="keyword">default</div><div class="operator">:</div>
		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;driver %v is not supported&#34;</div><div class="operator">,</div> <div class="ident">driverName</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">configuration</div><div class="operator">.</div><div class="ident">LogSQLQueries</div> <div class="operator">{</div>
		<div class="ident">driverName</div> <div class="operator">=</div> <div class="ident">InitSQLDriverWithLogs</div><div class="operator">(</div><div class="ident">driver</div><div class="operator">,</div> <div class="ident">driverName</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>MigrateToLatest migrates the database to the latest available
migration version. This must be done before an Init() call.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">MigrateToLatest</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">InitInfoTable</div><div class="operator">(</div><div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">,</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">dbDriverType</div><div class="operator">,</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">GetMaxVersion</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Init performs all database initialization
tasks necessary for further service operation.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">Init</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Read clusterName:LastChecked dictionary from DB.</p>
</td>
	<td class="code"><pre><code>	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="literal">&#34;SELECT cluster, last_checked_at FROM report;&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="operator">(</div>
			<div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator"></div>
			<div class="ident">lastChecked</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Time</div><div class="operator"></div>
		<div class="operator">)</div><div class="operator"></div>

		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">clusterName</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">lastChecked</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="keyword">if</div> <div class="ident">closeErr</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">closeErr</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
				<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">closeErr</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Unable to close the DB rows handle&#34;</div><div class="operator">)</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">storage</div><div class="operator">.</div><div class="ident">clustersLastChecked</div><div class="operator">[</div><div class="ident">clusterName</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">lastChecked</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Not using defer to close the rows here to:
- make errcheck happy (it doesn't like ignoring returned errors),
- return a possible error returned by the Close method.</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">return</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Close method closes the connection to database. Needs to be called at the end of application lifecycle.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Closing connection to data storage&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Can not close connection to data storage&#34;</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Report represents one (latest) cluster report.
    Org: organization ID
    Name: cluster GUID in the following format:
        c8590f31-e97e-4b85-b506-c45ce1911a12</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">Report</div> <div class="keyword">struct</div> <div class="operator">{</div>
	<div class="ident">Org</div>        <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div>         <div class="literal">`json:&#34;org&#34;`</div><div class="operator"></div>
	<div class="ident">Name</div>       <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div>   <div class="literal">`json:&#34;cluster&#34;`</div><div class="operator"></div>
	<div class="ident">Report</div>     <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReport</div> <div class="literal">`json:&#34;report&#34;`</div><div class="operator"></div>
	<div class="ident">ReportedAt</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">Timestamp</div>     <div class="literal">`json:&#34;reported_at&#34;`</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">closeRows</div><div class="operator">(</div><div class="ident">rows</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Rows</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">_</div> <div class="operator">=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ListOfOrgs reads list of all organizations that have at least one cluster report</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">ListOfOrgs</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">orgs</div> <div class="operator">:=</div> <div class="ident">make</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="literal">&#34;SELECT DISTINCT org_id FROM report ORDER BY org_id;&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ConvertDBError</div><div class="operator">(</div><div class="ident">err</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">orgs</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closeRows</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator"></div>

		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">orgs</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">orgs</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;ListOfOrgID&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">orgs</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ListOfClustersForOrg reads list of all clusters fro given organization</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">ListOfClustersForOrg</div><div class="operator">(</div><div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">timeLimit</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Time</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">clusters</div> <div class="operator">:=</div> <div class="ident">make</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">q</div> <div class="operator">:=</div> <div class="literal">`
		  SELECT cluster
		    FROM report
		   WHERE org_id = $1
		     AND reported_at &gt;= $2
		ORDER BY cluster;
	`</div><div class="operator"></div>

	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="ident">q</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">,</div> <div class="ident">timeLimit</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ConvertDBError</div><div class="operator">(</div><div class="ident">err</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">clusters</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closeRows</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="ident">clusterName</div> <div class="ident">string</div><div class="operator"></div>

		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">clusterName</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">clusters</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">clusters</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">(</div><div class="ident">clusterName</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;ListOfClustersForOrg&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">clusters</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ListOfClustersForOrgSpecificRule returns list of all clusters for given organization that are affect by given rule</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">ListOfClustersForOrgSpecificRule</div><div class="operator">(</div>
	<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
	<div class="ident">ruleID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">RuleSelector</div><div class="operator">,</div>
	<div class="ident">activeClusters</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">)</div> <div class="operator">(</div>
	<div class="operator">[</div><div class="operator">]</div><div class="ident">utypes</div><div class="operator">.</div><div class="ident">HittingClustersData</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">results</div> <div class="operator">:=</div> <div class="ident">make</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">utypes</div><div class="operator">.</div><div class="ident">HittingClustersData</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">var</div> <div class="ident">whereClause</div> <div class="ident">string</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">activeClusters</div><div class="operator">)</div> <div class="operator">&gt;</div> <div class="literal">0</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><h1>nosec G201</h1>
</td>
	<td class="code"><pre><code>		<div class="ident">whereClause</div> <div class="operator">=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprintf</div><div class="operator">(</div><div class="literal">`WHERE org_id = $1 AND rule_id = $2 AND cluster_id IN (%v)`</div><div class="operator">,</div>
			<div class="ident">inClauseFromSlice</div><div class="operator">(</div><div class="ident">activeClusters</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
		<div class="ident">whereClause</div> <div class="operator">=</div> <div class="literal">`WHERE org_id = $1 AND rule_id = $2`</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><h1>nosec G202</h1>
</td>
	<td class="code"><pre><code>	<div class="ident">query</div> <div class="operator">:=</div> <div class="literal">`SELECT cluster_id FROM recommendation `</div> <div class="operator">&#43;</div> <div class="ident">whereClause</div> <div class="operator">&#43;</div> <div class="literal">` ORDER BY cluster_id;`</div><div class="operator"></div>

	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="ident">query</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">,</div> <div class="ident">ruleID</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ConvertDBError</div><div class="operator">(</div><div class="ident">err</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">results</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">defer</div> <div class="ident">closeRows</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">var</div> <div class="operator">(</div>
		<div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator"></div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="keyword">for</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">clusterName</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">results</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">results</div><div class="operator">,</div> <div class="ident">utypes</div><div class="operator">.</div><div class="ident">HittingClustersData</div><div class="operator">{</div><div class="ident">Cluster</div><div class="operator">:</div> <div class="ident">clusterName</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;ListOfClustersForOrgSpecificRule&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>This is to ensure 404 when no recommendation is found for the given orgId + selector.
We can, alternatively, return something like this with a 204 (no content):
{&quot;data&quot;:[],&quot;meta&quot;:{&quot;count&quot;:0,&quot;component&quot;:&quot;test.rule&quot;,&quot;error<em>key&quot;:&quot;ek&quot;},&quot;status&quot;:&quot;not</em>found&quot;}</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">results</div><div class="operator">)</div> <div class="operator">==</div> <div class="literal">0</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">results</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ItemNotFoundError</div><div class="operator">{</div><div class="ident">ItemID</div><div class="operator">:</div> <div class="ident">ruleID</div><div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">results</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>GetOrgIDByClusterID reads OrgID for specified cluster</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">GetOrgIDByClusterID</div><div class="operator">(</div><div class="ident">cluster</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">row</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">&#34;SELECT org_id FROM report WHERE cluster = $1 ORDER BY org_id;&#34;</div><div class="operator">,</div> <div class="ident">cluster</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">var</div> <div class="ident">orgID</div> <div class="ident">uint64</div><div class="operator"></div>
	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">row</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;GetOrgIDByClusterID&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="literal">0</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>parseTemplateData parses template data and returns a json raw message if it's a json or a string otherwise</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">parseTemplateData</div><div class="operator">(</div><div class="ident">templateData</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">byte</div><div class="operator">)</div> <div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">templateDataJSON</div> <div class="ident">json</div><div class="operator">.</div><div class="ident">RawMessage</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">json</div><div class="operator">.</div><div class="ident">Unmarshal</div><div class="operator">(</div><div class="ident">templateData</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">templateDataJSON</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Warn</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;unable to parse template data as json&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">templateData</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">templateDataJSON</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">parseRuleRows</div><div class="operator">(</div><div class="ident">rows</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Rows</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RuleOnReport</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">report</div> <div class="operator">:=</div> <div class="ident">make</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RuleOnReport</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="operator">(</div>
			<div class="ident">templateDataBytes</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">byte</div><div class="operator"></div>
			<div class="ident">ruleFQDN</div>          <div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator"></div>
			<div class="ident">errorKey</div>          <div class="ident">types</div><div class="operator">.</div><div class="ident">ErrorKey</div><div class="operator"></div>
		<div class="operator">)</div><div class="operator"></div>

		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">templateDataBytes</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">ruleFQDN</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">errorKey</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;ReportListForCluster&#34;</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">report</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">templateData</div> <div class="operator">:=</div> <div class="ident">parseTemplateData</div><div class="operator">(</div><div class="ident">templateDataBytes</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">rule</div> <div class="operator">:=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">RuleOnReport</div><div class="operator">{</div>
			<div class="ident">Module</div><div class="operator">:</div>       <div class="ident">ruleFQDN</div><div class="operator">,</div>
			<div class="ident">ErrorKey</div><div class="operator">:</div>     <div class="ident">errorKey</div><div class="operator">,</div>
			<div class="ident">TemplateData</div><div class="operator">:</div> <div class="ident">templateData</div><div class="operator">,</div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">report</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">report</div><div class="operator">,</div> <div class="ident">rule</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">report</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>constructInClausule is a helper function to construct <code>in</code> clausule for SQL
statement.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">constructInClausule</div><div class="operator">(</div><div class="ident">howMany</div> <div class="ident">int</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">string</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>construct the <code>in</code> clausule in SQL query statement</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">howMany</div> <div class="operator">&lt;</div> <div class="literal">1</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="literal">&#34;&#34;</div><div class="operator">,</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;at least one value needed&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">inClausule</div> <div class="operator">:=</div> <div class="literal">&#34;$1&#34;</div><div class="operator"></div>
	<div class="keyword">for</div> <div class="ident">i</div> <div class="operator">:=</div> <div class="literal">2</div><div class="operator">;</div> <div class="ident">i</div> <div class="operator">&lt;=</div> <div class="ident">howMany</div><div class="operator">;</div> <div class="ident">i</div><div class="operator">&#43;&#43;</div> <div class="operator">{</div>
		<div class="ident">inClausule</div> <div class="operator">&#43;=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprintf</div><div class="operator">(</div><div class="literal">&#34;,$%d&#34;</div><div class="operator">,</div> <div class="ident">i</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">inClausule</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>argsWithClusterNames is a helper function to construct arguments for SQL
statement.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">argsWithClusterNames</div><div class="operator">(</div><div class="ident">clusterNames</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div> <div class="operator">[</div><div class="operator">]</div><div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare arguments</p>
</td>
	<td class="code"><pre><code>	<div class="ident">args</div> <div class="operator">:=</div> <div class="ident">make</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">clusterNames</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">i</div><div class="operator">,</div> <div class="ident">clusterName</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">clusterNames</div> <div class="operator">{</div>
		<div class="ident">args</div><div class="operator">[</div><div class="ident">i</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">clusterName</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">args</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>inClauseFromSlice is a helper function to construct <code>in</code> clause for SQL
statement from a given slice of items. The received slice must be []string
or any other type that can be asserted to []string, or else '1=1' will be
returned, making the IN clause act like a wildcard.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">inClauseFromSlice</div><div class="operator">(</div><div class="ident">slice</div> <div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">)</div> <div class="ident">string</div> <div class="operator">{</div>
	<div class="keyword">if</div> <div class="ident">slice</div><div class="operator">,</div> <div class="ident">ok</div> <div class="operator">:=</div> <div class="ident">slice</div><div class="operator">.</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">ok</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="literal">&#34;&#39;&#34;</div> <div class="operator">&#43;</div> <div class="ident">strings</div><div class="operator">.</div><div class="ident">Join</div><div class="operator">(</div><div class="ident">slice</div><div class="operator">,</div> <div class="literal">`&#39;,&#39;`</div><div class="operator">)</div> <div class="operator">&#43;</div> <div class="literal">`&#39;`</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="literal">&#34;1=1&#34;</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="comment">/*
func updateRecommendationsMetrics(cluster string, deleted float64, inserted float64) {
	metrics.SQLRecommendationsDeletes.WithLabelValues(cluster).Observe(deleted)
	metrics.SQLRecommendationsInserts.WithLabelValues(cluster).Observe(inserted)
}
*/</div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ReadOrgIDsForClusters read organization IDs for given list of cluster names.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">ReadOrgIDsForClusters</div><div class="operator">(</div><div class="ident">clusterNames</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>stub for return value</p>
</td>
	<td class="code"><pre><code>	<div class="ident">ids</div> <div class="operator">:=</div> <div class="ident">make</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">clusterNames</div><div class="operator">)</div> <div class="operator">&lt;</div> <div class="literal">1</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">ids</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare arguments</p>
</td>
	<td class="code"><pre><code>	<div class="ident">args</div> <div class="operator">:=</div> <div class="ident">argsWithClusterNames</div><div class="operator">(</div><div class="ident">clusterNames</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>construct the <code>in</code> clausule in SQL query statement</p>
</td>
	<td class="code"><pre><code>	<div class="ident">inClausule</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">constructInClausule</div><div class="operator">(</div><div class="ident">len</div><div class="operator">(</div><div class="ident">clusterNames</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">inClauseError</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">ids</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>disable &quot;G202 (CWE-89): SQL string concatenation&quot;</p>

<h1>nosec G202</h1>
</td>
	<td class="code"><pre><code>	<div class="ident">query</div> <div class="operator">:=</div> <div class="literal">&#34;SELECT DISTINCT org_id FROM report WHERE cluster in (&#34;</div> <div class="operator">&#43;</div> <div class="ident">inClausule</div> <div class="operator">&#43;</div> <div class="literal">&#34;);&#34;</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>select results from the database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="ident">query</div><div class="operator">,</div> <div class="ident">args</div><div class="operator">...</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;query to get org ids&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">ids</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>process results returned from database</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">for</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator"></div>

		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;read one org id&#34;</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">ids</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">ids</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">ids</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>everything seems ok -&gt; return ids</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">return</div> <div class="ident">ids</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ReadReportsForClusters function reads reports for given list of cluster
names.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">ReadReportsForClusters</div><div class="operator">(</div><div class="ident">clusterNames</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div> <div class="operator">(</div><div class="keyword">map</div><div class="operator">[</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReport</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>stub for return value</p>
</td>
	<td class="code"><pre><code>	<div class="ident">reports</div> <div class="operator">:=</div> <div class="ident">make</div><div class="operator">(</div><div class="keyword">map</div><div class="operator">[</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReport</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">clusterNames</div><div class="operator">)</div> <div class="operator">&lt;</div> <div class="literal">1</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">reports</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare arguments</p>
</td>
	<td class="code"><pre><code>	<div class="ident">args</div> <div class="operator">:=</div> <div class="ident">argsWithClusterNames</div><div class="operator">(</div><div class="ident">clusterNames</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>construct the <code>in</code> clausule in SQL query statement</p>
</td>
	<td class="code"><pre><code>	<div class="ident">inClausule</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">constructInClausule</div><div class="operator">(</div><div class="ident">len</div><div class="operator">(</div><div class="ident">clusterNames</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">inClauseError</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">reports</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>disable &quot;G202 (CWE-89): SQL string concatenation&quot;</p>

<h1>nosec G202</h1>
</td>
	<td class="code"><pre><code>	<div class="ident">query</div> <div class="operator">:=</div> <div class="literal">&#34;SELECT cluster, report FROM report WHERE cluster in (&#34;</div> <div class="operator">&#43;</div> <div class="ident">inClausule</div> <div class="operator">&#43;</div> <div class="literal">&#34;);&#34;</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>select results from the database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="ident">query</div><div class="operator">,</div> <div class="ident">args</div><div class="operator">...</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">reports</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>process results returned from database</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">for</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>convert into requested type</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">var</div> <div class="operator">(</div>
			<div class="ident">clusterName</div>   <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator"></div>
			<div class="ident">clusterReport</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReport</div><div class="operator"></div>
		<div class="operator">)</div><div class="operator"></div>

		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">clusterName</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">clusterReport</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;ReadReportsForClusters&#34;</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">reports</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">reports</div><div class="operator">[</div><div class="ident">clusterName</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">clusterReport</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>everything seems ok -&gt; return reports</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">return</div> <div class="ident">reports</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ReadReportForCluster reads result (health status) for selected cluster</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">ReadReportForCluster</div><div class="operator">(</div>
	<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RuleOnReport</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">lastChecked</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Time</div><div class="operator"></div>
	<div class="ident">report</div> <div class="operator">:=</div> <div class="ident">make</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RuleOnReport</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div>
		<div class="literal">&#34;SELECT last_checked_at FROM report WHERE org_id = $1 AND cluster = $2;&#34;</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">lastChecked</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ConvertDBError</div><div class="operator">(</div><div class="ident">err</div><div class="operator">,</div> <div class="operator">[</div><div class="operator">]</div><div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">{</div><div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">report</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator">(</div><div class="ident">lastChecked</div><div class="operator">.</div><div class="ident">UTC</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Format</div><div class="operator">(</div><div class="ident">time</div><div class="operator">.</div><div class="ident">RFC3339</div><div class="operator">)</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div>
		<div class="literal">&#34;SELECT template_data, rule_fqdn, error_key FROM rule_hit WHERE org_id = $1 AND cluster_id = $2;&#34;</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ConvertDBError</div><div class="operator">(</div><div class="ident">err</div><div class="operator">,</div> <div class="operator">[</div><div class="operator">]</div><div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">{</div><div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">report</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator">(</div><div class="ident">lastChecked</div><div class="operator">.</div><div class="ident">UTC</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Format</div><div class="operator">(</div><div class="ident">time</div><div class="operator">.</div><div class="ident">RFC3339</div><div class="operator">)</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">report</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">parseRuleRows</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">report</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator">(</div><div class="ident">lastChecked</div><div class="operator">.</div><div class="ident">UTC</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Format</div><div class="operator">(</div><div class="ident">time</div><div class="operator">.</div><div class="ident">RFC3339</div><div class="operator">)</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ReadSingleRuleTemplateData reads template data for a single rule</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">ReadSingleRuleTemplateData</div><div class="operator">(</div>
	<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div> <div class="ident">ruleID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">,</div> <div class="ident">errorKey</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ErrorKey</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div><div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">templateDataBytes</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">byte</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">`
		SELECT template_data FROM rule_hit
		WHERE org_id = $1 AND cluster_id = $2 AND rule_fqdn = $3 AND error_key = $4;
	`</div><div class="operator">,</div>
		<div class="ident">orgID</div><div class="operator">,</div>
		<div class="ident">clusterName</div><div class="operator">,</div>
		<div class="ident">ruleID</div><div class="operator">,</div>
		<div class="ident">errorKey</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">templateDataBytes</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ConvertDBError</div><div class="operator">(</div><div class="ident">err</div><div class="operator">,</div> <div class="operator">[</div><div class="operator">]</div><div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">{</div><div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">,</div> <div class="ident">ruleID</div><div class="operator">,</div> <div class="ident">errorKey</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">parseTemplateData</div><div class="operator">(</div><div class="ident">templateDataBytes</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ReadReportForClusterByClusterName reads result (health status) for selected cluster for given organization</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">ReadReportForClusterByClusterName</div><div class="operator">(</div>
	<div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RuleOnReport</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">report</div> <div class="operator">:=</div> <div class="ident">make</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RuleOnReport</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">var</div> <div class="ident">lastChecked</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Time</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div>
		<div class="literal">&#34;SELECT last_checked_at FROM report WHERE cluster = $1;&#34;</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">lastChecked</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">switch</div> <div class="operator">{</div>
	<div class="keyword">case</div> <div class="ident">err</div> <div class="operator">==</div> <div class="ident">sql</div><div class="operator">.</div><div class="ident">ErrNoRows</div><div class="operator">:</div>
		<div class="keyword">return</div> <div class="ident">report</div><div class="operator">,</div> <div class="literal">&#34;&#34;</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ItemNotFoundError</div><div class="operator">{</div>
			<div class="ident">ItemID</div><div class="operator">:</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprintf</div><div class="operator">(</div><div class="literal">&#34;%v&#34;</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">)</div><div class="operator">,</div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">case</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div><div class="operator">:</div>
		<div class="keyword">return</div> <div class="ident">report</div><div class="operator">,</div> <div class="literal">&#34;&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div>
		<div class="literal">&#34;SELECT template_data, rule_fqdn, error_key FROM rule_hit WHERE cluster_id = $1;&#34;</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">report</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator">(</div><div class="ident">lastChecked</div><div class="operator">.</div><div class="ident">UTC</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Format</div><div class="operator">(</div><div class="ident">time</div><div class="operator">.</div><div class="ident">RFC3339</div><div class="operator">)</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">report</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">parseRuleRows</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">report</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator">(</div><div class="ident">lastChecked</div><div class="operator">.</div><div class="ident">UTC</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Format</div><div class="operator">(</div><div class="ident">time</div><div class="operator">.</div><div class="ident">RFC3339</div><div class="operator">)</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>GetLatestKafkaOffset returns latest kafka offset from report table</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">GetLatestKafkaOffset</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">types</div><div class="operator">.</div><div class="ident">KafkaOffset</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">offset</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">KafkaOffset</div><div class="operator"></div>
	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">&#34;SELECT COALESCE(MAX(kafka_offset), 0) FROM report;&#34;</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">offset</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">offset</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">getReportUpsertQuery</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">string</div> <div class="operator">{</div>
	<div class="keyword">if</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">dbDriverType</div> <div class="operator">==</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverSQLite3</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="literal">`
			INSERT OR REPLACE INTO report(org_id, cluster, report, reported_at, last_checked_at, kafka_offset)
			VALUES ($1, $2, $3, $4, $5, $6)
		`</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="literal">`
		INSERT INTO report(org_id, cluster, report, reported_at, last_checked_at, kafka_offset)
		VALUES ($1, $2, $3, $4, $5, $6)
		ON CONFLICT (cluster)
		DO UPDATE SET org_id = $1, report = $3, reported_at = $4, last_checked_at = $5, kafka_offset = $6
	`</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">getRuleHitUpsertQuery</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">string</div> <div class="operator">{</div>
	<div class="keyword">if</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">dbDriverType</div> <div class="operator">==</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverSQLite3</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="literal">`
			INSERT OR REPLACE INTO rule_hit(org_id, cluster_id, rule_fqdn, error_key, template_data)
			VALUES ($1, $2, $3, $4, $5)
		`</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="literal">`
		INSERT INTO rule_hit(org_id, cluster_id, rule_fqdn, error_key, template_data)
		VALUES ($1, $2, $3, $4, $5)
		ON CONFLICT (org_id, cluster_id, rule_fqdn, error_key)
		DO UPDATE SET template_data = $4
	`</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">updateReport</div><div class="operator">(</div>
	<div class="ident">tx</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Tx</div><div class="operator">,</div>
	<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
	<div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
	<div class="ident">report</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReport</div><div class="operator">,</div>
	<div class="ident">rules</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ReportItem</div><div class="operator">,</div>
	<div class="ident">lastCheckedTime</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Time</div><div class="operator">,</div>
	<div class="ident">kafkaOffset</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">KafkaOffset</div><div class="operator">,</div>
<div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Get the UPSERT query for writing a report into the database.</p>
</td>
	<td class="code"><pre><code>	<div class="ident">reportUpsertQuery</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">getReportUpsertQuery</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Get the UPSERT query for writing a rule into the database.</p>
</td>
	<td class="code"><pre><code>	<div class="ident">ruleUpsertQuery</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">getRuleHitUpsertQuery</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">deleteQuery</div> <div class="operator">:=</div> <div class="literal">&#34;DELETE FROM rule_hit WHERE org_id = $1 AND cluster_id = $2;&#34;</div><div class="operator"></div>
	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">tx</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="ident">deleteQuery</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;Unable to remove previous cluster reports (org: %v, cluster: %v)&#34;</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Perform the report upsert.</p>
</td>
	<td class="code"><pre><code>	<div class="ident">reportedAtTime</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">rule</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">rules</div> <div class="operator">{</div>
		<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">tx</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="ident">ruleUpsertQuery</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">,</div> <div class="ident">rule</div><div class="operator">.</div><div class="ident">Module</div><div class="operator">,</div> <div class="ident">rule</div><div class="operator">.</div><div class="ident">ErrorKey</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">rule</div><div class="operator">.</div><div class="ident">TemplateData</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;Unable to upsert the cluster report rules (org: %v, cluster: %v, rule: %v|%v)&#34;</div><div class="operator">,</div>
				<div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">,</div> <div class="ident">rule</div><div class="operator">.</div><div class="ident">Module</div><div class="operator">,</div> <div class="ident">rule</div><div class="operator">.</div><div class="ident">ErrorKey</div><div class="operator">,</div>
			<div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">tx</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="ident">reportUpsertQuery</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">,</div> <div class="ident">report</div><div class="operator">,</div> <div class="ident">reportedAtTime</div><div class="operator">,</div> <div class="ident">lastCheckedTime</div><div class="operator">,</div> <div class="ident">kafkaOffset</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;Unable to upsert the cluster report (org: %v, cluster: %v)&#34;</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">prepareInsertRecommendationsStatement</div><div class="operator">(</div>
	<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
	<div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
	<div class="ident">report</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ReportRules</div><div class="operator">,</div>
	<div class="ident">createdAt</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Time</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div><div class="ident">selectors</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">,</div> <div class="ident">statement</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">statementArgs</div> <div class="operator">[</div><div class="operator">]</div><div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">statement</div> <div class="operator">=</div> <div class="literal">`INSERT INTO recommendation (org_id, cluster_id, rule_fqdn, error_key, rule_id, created_at) VALUES %s`</div><div class="operator"></div>

	<div class="keyword">var</div> <div class="ident">valuesIdx</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator"></div>
	<div class="ident">statementIdx</div> <div class="operator">:=</div> <div class="literal">0</div><div class="operator"></div>
	<div class="ident">selectors</div> <div class="operator">=</div> <div class="ident">make</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">,</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">report</div><div class="operator">.</div><div class="ident">HitRules</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">idx</div><div class="operator">,</div> <div class="ident">rule</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">report</div><div class="operator">.</div><div class="ident">HitRules</div> <div class="operator">{</div>
		<div class="ident">ruleFqdn</div> <div class="operator">:=</div> <div class="ident">strings</div><div class="operator">.</div><div class="ident">TrimSuffix</div><div class="operator">(</div><div class="ident">string</div><div class="operator">(</div><div class="ident">rule</div><div class="operator">.</div><div class="ident">Module</div><div class="operator">)</div><div class="operator">,</div> <div class="literal">&#34;.report&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">ruleID</div> <div class="operator">:=</div> <div class="ident">ruleFqdn</div> <div class="operator">&#43;</div> <div class="literal">&#34;|&#34;</div> <div class="operator">&#43;</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">rule</div><div class="operator">.</div><div class="ident">ErrorKey</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">selectors</div><div class="operator">[</div><div class="ident">idx</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">ruleID</div><div class="operator"></div>
		<div class="ident">statementArgs</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">statementArgs</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">,</div> <div class="ident">ruleFqdn</div><div class="operator">,</div> <div class="ident">rule</div><div class="operator">.</div><div class="ident">ErrorKey</div><div class="operator">,</div> <div class="ident">ruleID</div><div class="operator">,</div> <div class="ident">createdAt</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">statementIdx</div> <div class="operator">=</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">statementArgs</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">valuesIdx</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">valuesIdx</div><div class="operator">,</div> <div class="literal">&#34;($&#34;</div><div class="operator">&#43;</div><div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprint</div><div class="operator">(</div><div class="ident">statementIdx</div><div class="operator">-</div><div class="literal">5</div><div class="operator">)</div><div class="operator">&#43;</div>
			<div class="literal">&#34;, $&#34;</div><div class="operator">&#43;</div><div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprint</div><div class="operator">(</div><div class="ident">statementIdx</div><div class="operator">-</div><div class="literal">4</div><div class="operator">)</div><div class="operator">&#43;</div>
			<div class="literal">&#34;, $&#34;</div><div class="operator">&#43;</div><div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprint</div><div class="operator">(</div><div class="ident">statementIdx</div><div class="operator">-</div><div class="literal">3</div><div class="operator">)</div><div class="operator">&#43;</div>
			<div class="literal">&#34;, $&#34;</div><div class="operator">&#43;</div><div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprint</div><div class="operator">(</div><div class="ident">statementIdx</div><div class="operator">-</div><div class="literal">2</div><div class="operator">)</div><div class="operator">&#43;</div>
			<div class="literal">&#34;, $&#34;</div><div class="operator">&#43;</div><div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprint</div><div class="operator">(</div><div class="ident">statementIdx</div><div class="operator">-</div><div class="literal">1</div><div class="operator">)</div><div class="operator">&#43;</div>
			<div class="literal">&#34;, $&#34;</div><div class="operator">&#43;</div><div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprint</div><div class="operator">(</div><div class="ident">statementIdx</div><div class="operator">)</div><div class="operator">&#43;</div><div class="literal">&#34;)&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">statement</div> <div class="operator">=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprintf</div><div class="operator">(</div><div class="ident">statement</div><div class="operator">,</div> <div class="ident">strings</div><div class="operator">.</div><div class="ident">Join</div><div class="operator">(</div><div class="ident">valuesIdx</div><div class="operator">,</div> <div class="literal">&#34;,&#34;</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">return</div><div class="operator"></div>

<div class="operator">}</div><div class="operator"></div>
<div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">insertRecommendations</div><div class="operator">(</div>
	<div class="ident">tx</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Tx</div><div class="operator">,</div>
	<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
	<div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
	<div class="ident">report</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ReportRules</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div><div class="ident">inserted</div> <div class="ident">int</div><div class="operator">,</div> <div class="ident">err</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">if</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">report</div><div class="operator">.</div><div class="ident">HitRules</div><div class="operator">)</div> <div class="operator">==</div> <div class="literal">0</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Int</div><div class="operator">(</div><div class="ident">organizationKey</div><div class="operator">,</div> <div class="ident">int</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Str</div><div class="operator">(</div><div class="ident">clusterKey</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">clusterName</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Int</div><div class="operator">(</div><div class="ident">issuesCountKey</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;No new recommendation to insert&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="literal">0</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">creationTime</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">UTC</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">selectors</div><div class="operator">,</div> <div class="ident">statement</div><div class="operator">,</div> <div class="ident">args</div> <div class="operator">:=</div> <div class="ident">prepareInsertRecommendationsStatement</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">,</div> <div class="ident">report</div><div class="operator">,</div> <div class="ident">creationTime</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">inserted</div> <div class="operator">=</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">selectors</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">tx</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="ident">statement</div><div class="operator">,</div> <div class="ident">args</div><div class="operator">...</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Int</div><div class="operator">(</div><div class="ident">organizationKey</div><div class="operator">,</div> <div class="ident">int</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Str</div><div class="operator">(</div><div class="ident">clusterKey</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">clusterName</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Int</div><div class="operator">(</div><div class="ident">issuesCountKey</div><div class="operator">,</div> <div class="ident">inserted</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Time</div><div class="operator">(</div><div class="ident">createdAtKey</div><div class="operator">,</div> <div class="ident">creationTime</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Strs</div><div class="operator">(</div><div class="ident">selectorsKey</div><div class="operator">,</div> <div class="ident">selectors</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Unable to insert the recommendations&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="literal">0</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Int</div><div class="operator">(</div><div class="ident">organizationKey</div><div class="operator">,</div> <div class="ident">int</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Str</div><div class="operator">(</div><div class="ident">clusterKey</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">clusterName</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Int</div><div class="operator">(</div><div class="ident">issuesCountKey</div><div class="operator">,</div> <div class="ident">inserted</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Time</div><div class="operator">(</div><div class="ident">createdAtKey</div><div class="operator">,</div> <div class="ident">creationTime</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Strs</div><div class="operator">(</div><div class="ident">selectorsKey</div><div class="operator">,</div> <div class="ident">selectors</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Recommendations inserted successfully&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">return</div><div class="operator"></div>

<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>WriteReportForCluster writes result (health status) for selected cluster for given organization</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">WriteReportForCluster</div><div class="operator">(</div>
	<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
	<div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
	<div class="ident">report</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReport</div><div class="operator">,</div>
	<div class="ident">rules</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ReportItem</div><div class="operator">,</div>
	<div class="ident">lastCheckedTime</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Time</div><div class="operator">,</div>
	<div class="ident">kafkaOffset</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">KafkaOffset</div><div class="operator">,</div>
<div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Skip writing the report if it isn't newer than a report
that is already in the database for the same cluster.</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">oldLastChecked</div><div class="operator">,</div> <div class="ident">exists</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">clustersLastChecked</div><div class="operator">[</div><div class="ident">clusterName</div><div class="operator">]</div><div class="operator">;</div> <div class="ident">exists</div> <div class="operator">&amp;&amp;</div> <div class="operator">!</div><div class="ident">lastCheckedTime</div><div class="operator">.</div><div class="ident">After</div><div class="operator">(</div><div class="ident">oldLastChecked</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ErrOldReport</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">dbDriverType</div> <div class="operator">!=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverSQLite3</div> <div class="operator">&amp;&amp;</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">dbDriverType</div> <div class="operator">!=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverPostgres</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;writing report with DB %v is not supported&#34;</div><div class="operator">,</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">dbDriverType</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Begin a new transaction.</p>
</td>
	<td class="code"><pre><code>	<div class="ident">tx</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Begin</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="keyword">func</div><div class="operator">(</div><div class="ident">tx</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Tx</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Check if there is a more recent report for the cluster already in the database.</p>
</td>
	<td class="code"><pre><code>		<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">tx</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div>
			<div class="literal">&#34;SELECT last_checked_at FROM report WHERE org_id = $1 AND cluster = $2 AND last_checked_at &gt; $3;&#34;</div><div class="operator">,</div>
			<div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">,</div> <div class="ident">lastCheckedTime</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ConvertDBError</div><div class="operator">(</div><div class="ident">err</div><div class="operator">,</div> <div class="operator">[</div><div class="operator">]</div><div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">{</div><div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Unable to look up the most recent report in the database&#34;</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="keyword">defer</div> <div class="ident">closeRows</div><div class="operator">(</div><div class="ident">rows</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>If there is one, print a warning and discard the report (don't update it).</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Warn</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;Database already contains report for organization %d and cluster name %s more recent than %v&#34;</div><div class="operator">,</div>
				<div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">,</div> <div class="ident">lastCheckedTime</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">updateReport</div><div class="operator">(</div><div class="ident">tx</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">,</div> <div class="ident">report</div><div class="operator">,</div> <div class="ident">rules</div><div class="operator">,</div> <div class="ident">lastCheckedTime</div><div class="operator">,</div> <div class="ident">kafkaOffset</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">storage</div><div class="operator">.</div><div class="ident">clustersLastChecked</div><div class="operator">[</div><div class="ident">clusterName</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">lastCheckedTime</div><div class="operator"></div>
		<div class="ident">metrics</div><div class="operator">.</div><div class="ident">WrittenReports</div><div class="operator">.</div><div class="ident">Inc</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="ident">tx</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">finishTransaction</div><div class="operator">(</div><div class="ident">tx</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>WriteRecommendationsForCluster writes hitting rules in received report for selected cluster</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">WriteRecommendationsForCluster</div><div class="operator">(</div>
	<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
	<div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
	<div class="ident">stringReport</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReport</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div><div class="ident">err</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">report</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ReportRules</div><div class="operator"></div>
	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">json</div><div class="operator">.</div><div class="ident">Unmarshal</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">byte</div><div class="operator">(</div><div class="ident">stringReport</div><div class="operator">)</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">report</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">tx</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Begin</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="keyword">func</div><div class="operator">(</div><div class="ident">tx</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Tx</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="ident">deleted</div> <div class="ident">int64</div> <div class="operator">=</div> <div class="literal">0</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Delete current recommendations for the cluster if some report has been previously stored for this cluster</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">ok</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">clustersLastChecked</div><div class="operator">[</div><div class="ident">clusterName</div><div class="operator">]</div><div class="operator">;</div> <div class="ident">ok</div> <div class="operator">{</div>
			<div class="ident">result</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">tx</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div>
				<div class="literal">&#34;DELETE FROM recommendation WHERE cluster_id = $1;&#34;</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">err</div> <div class="operator">=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ConvertDBError</div><div class="operator">(</div><div class="ident">err</div><div class="operator">,</div> <div class="operator">[</div><div class="operator">]</div><div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">{</div><div class="ident">clusterName</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
				<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;Unable to delete the existing recommendations for %s&#34;</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">)</div><div class="operator"></div>
				<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>As the documentation says:
RowsAffected returns the number of rows affected by an
update, insert, or delete. Not every database or database
driver may support this.
So we might run in a scenario where we don't have metrics
if the driver doesn't help.</p>
</td>
	<td class="code"><pre><code>			<div class="ident">deleted</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">result</div><div class="operator">.</div><div class="ident">RowsAffected</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
				<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Unable to retrieve number of deleted rows with current driver&#34;</div><div class="operator">)</div><div class="operator"></div>
				<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">inserted</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">insertRecommendations</div><div class="operator">(</div><div class="ident">tx</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">,</div> <div class="ident">report</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Int64</div><div class="operator">(</div><div class="literal">&#34;Deleted&#34;</div><div class="operator">,</div> <div class="ident">deleted</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Int</div><div class="operator">(</div><div class="literal">&#34;Inserted&#34;</div><div class="operator">,</div> <div class="ident">inserted</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Int</div><div class="operator">(</div><div class="ident">organizationKey</div><div class="operator">,</div> <div class="ident">int</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Str</div><div class="operator">(</div><div class="ident">clusterKey</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">clusterName</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Updated recommendation table&#34;</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>updateRecommendationsMetrics(string(clusterName), float64(deleted), float64(inserted))</p>
</td>
	<td class="code"><pre><code>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="ident">tx</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">finishTransaction</div><div class="operator">(</div><div class="ident">tx</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>finishTransaction finishes the transaction depending on err. err == nil -&gt; commit, err != nil -&gt; rollback</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">finishTransaction</div><div class="operator">(</div><div class="ident">tx</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Tx</div><div class="operator">,</div> <div class="ident">err</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">rollbackError</div> <div class="operator">:=</div> <div class="ident">tx</div><div class="operator">.</div><div class="ident">Rollback</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">rollbackError</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">rollbackError</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;error when trying to rollback a transaction&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
		<div class="ident">commitError</div> <div class="operator">:=</div> <div class="ident">tx</div><div class="operator">.</div><div class="ident">Commit</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">commitError</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">commitError</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;error when trying to commit a transaction&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ReadRecommendationsForClusters reads all recommendations from recommendation table for given organization</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">ReadRecommendationsForClusters</div><div class="operator">(</div>
	<div class="ident">clusterList</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div><div class="ident">utypes</div><div class="operator">.</div><div class="ident">RecommendationImpactedClusters</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>

	<div class="ident">recommendationsMap</div> <div class="operator">:=</div> <div class="ident">make</div><div class="operator">(</div><div class="ident">utypes</div><div class="operator">.</div><div class="ident">RecommendationImpactedClusters</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">clusterList</div><div class="operator">)</div> <div class="operator">&lt;</div> <div class="literal">1</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">recommendationsMap</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare arguments</p>
</td>
	<td class="code"><pre><code>	<div class="ident">args</div> <div class="operator">:=</div> <div class="ident">argsWithClusterNames</div><div class="operator">(</div><div class="ident">clusterList</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>construct the <code>in</code> clausule in SQL query statement</p>
</td>
	<td class="code"><pre><code>	<div class="ident">inClausule</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">constructInClausule</div><div class="operator">(</div><div class="ident">len</div><div class="operator">(</div><div class="ident">clusterList</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">inClauseError</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">recommendationsMap</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>disable &quot;G202 (CWE-89): SQL string concatenation&quot;</p>

<h1>nosec G202</h1>
</td>
	<td class="code"><pre><code>	<div class="ident">query</div> <div class="operator">:=</div> <div class="literal">`
	SELECT
		rule_id, count(*) as impacted_clusters_c
	FROM
		recommendation
	WHERE
		cluster_id in (`</div> <div class="operator">&#43;</div> <div class="ident">inClausule</div> <div class="operator">&#43;</div> <div class="literal">`)
	GROUP BY
		rule_id
	`</div><div class="operator"></div>
	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="ident">query</div><div class="operator">,</div> <div class="ident">args</div><div class="operator">...</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;query to get recommendations&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">recommendationsMap</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="operator">(</div>
			<div class="ident">ruleID</div>      <div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator"></div>
			<div class="ident">impactedCnt</div> <div class="ident">utypes</div><div class="operator">.</div><div class="ident">ImpactedClustersCnt</div><div class="operator"></div>
		<div class="operator">)</div><div class="operator"></div>

		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div>
			<div class="operator">&amp;</div><div class="ident">ruleID</div><div class="operator">,</div>
			<div class="operator">&amp;</div><div class="ident">impactedCnt</div><div class="operator">,</div>
		<div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;read one recommendation&#34;</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">recommendationsMap</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">recommendationsMap</div><div class="operator">[</div><div class="ident">ruleID</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">impactedCnt</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">recommendationsMap</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ReportsCount reads number of all records stored in database</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">ReportsCount</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">int</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">count</div> <div class="operator">:=</div> <div class="operator">-</div><div class="literal">1</div><div class="operator"></div>
	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">&#34;SELECT count(*) FROM report;&#34;</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">count</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ConvertDBError</div><div class="operator">(</div><div class="ident">err</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">count</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>DeleteReportsForOrg deletes all reports related to the specified organization from the storage.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">DeleteReportsForOrg</div><div class="operator">(</div><div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">&#34;DELETE FROM report WHERE org_id = $1;&#34;</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>DeleteReportsForCluster deletes all reports related to the specified cluster from the storage.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">DeleteReportsForCluster</div><div class="operator">(</div><div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">&#34;DELETE FROM report WHERE cluster = $1;&#34;</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>GetConnection returns db connection(useful for testing)</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">GetConnection</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div> <div class="operator">{</div>
	<div class="keyword">return</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>WriteConsumerError writes a report about a consumer error into the storage.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">WriteConsumerError</div><div class="operator">(</div><div class="ident">msg</div> <div class="operator">*</div><div class="ident">sarama</div><div class="operator">.</div><div class="ident">ConsumerMessage</div><div class="operator">,</div> <div class="ident">consumerErr</div> <div class="ident">error</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`
		INSERT INTO consumer_error (topic, partition, topic_offset, key, produced_at, consumed_at, message, error)
		VALUES ($1, $2, $3, $4, $5, $6, $7, $8)`</div><div class="operator">,</div>
		<div class="ident">msg</div><div class="operator">.</div><div class="ident">Topic</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Partition</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Offset</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Key</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator">,</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">UTC</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Value</div><div class="operator">,</div> <div class="ident">consumerErr</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>GetDBDriverType returns db driver type</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">GetDBDriverType</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriver</div> <div class="operator">{</div>
	<div class="keyword">return</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">dbDriverType</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>DoesClusterExist checks if cluster with this id exists</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">DoesClusterExist</div><div class="operator">(</div><div class="ident">clusterID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">bool</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div>
		<div class="literal">&#34;SELECT cluster FROM report WHERE cluster = $1&#34;</div><div class="operator">,</div> <div class="ident">clusterID</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">clusterID</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">==</div> <div class="ident">sql</div><div class="operator">.</div><div class="ident">ErrNoRows</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">false</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
	<div class="operator">}</div> <div class="keyword">else</div> <div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">false</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">true</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
    </tbody>
  </table>
</div>
</body>
</html>
